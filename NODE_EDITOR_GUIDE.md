# ノードエディタ機能ガイド

RayTraceVSのノードエディタが完全に実装され、直感的なノードベースのシーン編集が可能になりました。

## 実装された機能

### 1. ノードのドラッグ＆ドロップ（移動）

- **操作方法**: ノードを左クリックしてドラッグすることで、キャンバス上の任意の位置に移動できます
- **実装詳細**: 
  - マウスの左ボタンを押している間、ノードがマウスに追従します
  - ドラッグ中は接続線も自動的に更新されます
  - ノードの位置はリアルタイムで反映されます

### 2. ソケット間の接続作成

- **操作方法**: 
  1. 出力ソケット（ノードの右側の丸）をクリック
  2. マウスをドラッグして接続先の入力ソケット（ノードの左側の丸）に移動
  3. マウスボタンを離すと接続が作成されます
  
- **接続ルール**:
  - 出力ソケット → 入力ソケットの方向のみ接続可能
  - 同じノード内のソケット同士は接続不可
  - 入力ソケットには1つの接続のみ（新しい接続で既存の接続を上書き）
  - 出力ソケットは複数の入力ソケットに接続可能

- **ビジュアル**:
  - 接続線はベジェ曲線で描画され、滑らかに表示されます
  - アクセントカラー（青）でハイライト表示
  - グローエフェクト付きで視認性向上

### 3. キャンバスのパン（移動）

- **操作方法**: マウスの右ボタンをクリックしてドラッグ
- **用途**: 大きなノードグラフを探索する際に便利
- **実装詳細**: TranslateTransformを使用した平行移動

### 4. キャンバスのズーム

- **操作方法**: マウスホイールを回転
  - 上方向スクロール: ズームイン（拡大）
  - 下方向スクロール: ズームアウト（縮小）
  
- **ズーム範囲**: 0.1倍 ～ 5.0倍
- **機能**: マウスカーソル位置を中心にズーム
- **実装詳細**: ScaleTransformを使用

### 5. ノードの選択

- **操作方法**: ノードをクリック
- **視覚的フィードバック**:
  - 選択されたノードは青い枠線でハイライト
  - 未選択のノードはグレーの枠線
- **機能**: 選択したノードのプロパティが右パネルに表示されます

### 6. プロパティパネル

選択したノードの詳細情報を右パネルに表示：

- **表示内容**:
  - ノード名（タイトル）
  - ノードタイプ（カテゴリ）
  - キャンバス上の位置（X, Y座標）
  - 入力ソケット一覧
  - 出力ソケット一覧
  - 削除ボタン

### 7. ノードの削除

2つの方法でノードを削除できます：

1. **Deleteキーで削除**:
   - ノードを選択してDeleteキーを押す
   - キャンバスにフォーカスがある状態で動作

2. **プロパティパネルから削除**:
   - ノードを選択
   - 右パネルの「ノードを削除」ボタンをクリック
   - 確認ダイアログが表示されます

- **動作**: ノード削除時、関連する接続も自動的に削除されます

### 8. コンポーネントパレット

左パネルから新しいノードを追加：

- **オブジェクト**: 球、平面、円柱
- **数学**: Vector3（位置・方向ベクトル）
- **カメラ**: カメラノード
- **ライト**: ポイントライト
- **シーン**: シーン出力ノード

**使用方法**: カテゴリを展開してボタンをクリックするとノードが追加されます

## キーボードショートカット

- **Delete**: 選択したノードを削除

## マウス操作まとめ

| 操作 | 機能 |
|------|------|
| 左クリック + ドラッグ（ノード上） | ノードを移動 |
| 左クリック + ドラッグ（ソケット上） | 接続を作成 |
| 左クリック（空白） | 選択解除 |
| 右クリック + ドラッグ | キャンバスをパン |
| マウスホイール | ズーム |

## 技術実装の詳細

### アーキテクチャ

- **MVVM パターン**: ViewModelを通じたデータバインディング
- **ObservableCollection**: ノードと接続の自動UI更新
- **WPF トランスフォーム**: パン・ズーム機能の実装
- **ヒットテスト**: VisualTreeHelperを使った正確なクリック判定

### 主要クラス

1. **NodeEditorView**: ノードエディタのメインビュー
   - ドラッグ＆ドロップロジック
   - パン・ズーム処理
   - キーボード入力処理

2. **Node**: ノードの基底クラス
   - 位置、タイトル、カテゴリ
   - 入力・出力ソケットの管理
   - 選択状態の管理

3. **NodeSocket**: ソケット（入出力ポート）
   - ソケットタイプ（Object, Vector3, Float, etc.）
   - 親ノードへの参照
   - 値の保持

4. **NodeConnection**: ノード間の接続
   - 出力ソケットから入力ソケットへの接続
   - ベジェ曲線によるパスの計算
   - リアルタイム更新

5. **MainViewModel**: アプリケーションのメインViewModel
   - ノードコレクションの管理
   - 接続コレクションの管理
   - 選択状態の管理

### カスタムコンバーター

- **BoolToSelectionBrushConverter**: 選択状態に応じた枠線の色変更
- **NullToVisibilityConverter**: nullの場合に表示
- **NotNullToVisibilityConverter**: nullでない場合に表示

## 今後の拡張性

現在の実装は以下の拡張が可能です：

1. **プロパティの編集**: ノードの詳細パラメータの編集UI
2. **コンテキストメニュー**: 右クリックでの操作メニュー
3. **複数選択**: Ctrl+クリックでの複数ノード選択
4. **コピー＆ペースト**: ノードの複製機能
5. **Undo/Redo**: 操作履歴の管理
6. **ミニマップ**: 大きなグラフのナビゲーション
7. **接続のプレビュー**: ドラッグ中の接続線表示
8. **スナップ機能**: グリッドへのスナップ

## トラブルシューティング

### 接続が表示されない
- ノードを移動すると接続線が更新されます
- レンダリングウィンドウを閉じて再度開いてみてください

### ノードが選択できない
- キャンバスをクリックしてフォーカスを取得してください
- ズームレベルを調整してみてください

### キャンバスが動かない
- 右クリック（パン）と左クリック（選択/ドラッグ）を確認してください
- マウスホイールでズームできるか確認してください
