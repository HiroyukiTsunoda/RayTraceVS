# ノードエディタ機能ガイド

RayTraceVSのノードエディタが完全に実装され、直感的なノードベースのシーン編集が可能になりました。

## 実装された機能

### 1. ノードのドラッグ＆ドロップ（移動）

- **操作方法**: ノードを左クリックしてドラッグすることで、キャンバス上の任意の位置に移動できます
- **実装詳細**: 
  - マウスの左ボタンを押している間、ノードがマウスに追従します
  - ドラッグ中は接続線も自動的に更新されます
  - ノードの位置はリアルタイムで反映されます
  - **移動はUndo/Redo対応**

### 2. ソケット間の接続作成

- **操作方法**: 
  1. 出力ソケット（ノードの右側の丸）をクリック
  2. マウスをドラッグして接続先の入力ソケット（ノードの左側の丸）に移動
  3. マウスボタンを離すと接続が作成されます
  
- **接続ルール**:
  - 出力ソケット → 入力ソケットの方向のみ接続可能
  - 同じノード内のソケット同士は接続不可
  - 入力ソケットには1つの接続のみ（新しい接続で既存の接続を上書き）
  - 出力ソケットは複数の入力ソケットに接続可能
  - **ソケット型の互換性チェック**（互換性がない場合は赤色で表示）

- **接続の再配線**:
  - 既存の接続がある入力ソケットをドラッグすると、接続を別のソケットに付け替えられます
  - 何もない場所にドロップすると接続が削除されます（Undo可能）

- **ビジュアル**:
  - 接続線はベジェ曲線で描画され、滑らかに表示されます
  - ドラッグ中のプレビュー線は点線で表示
  - **互換性に応じた色表示**：接続可能な場合は実線、不可能な場合は赤色

### 3. ノードの選択

#### 単一選択
- **操作方法**: ノードをクリック
- **視覚的フィードバック**:
  - 選択されたノードは青い枠線でハイライト
  - 未選択のノードはグレーの枠線
- **機能**: 選択したノードのプロパティが右パネルに表示されます

#### 複数選択（矩形選択）
- **操作方法**: キャンバスの空白部分から左クリック＆ドラッグで矩形を描く
- **動作**: 矩形内に完全に収まるノードが全て選択されます
- **視覚的フィードバック**: 
  - ドラッグ中は半透明の青い選択矩形が表示されます
  - 選択されたノードは全て青い枠線でハイライト
- **注意**: 複数選択時はプロパティパネルの表示はクリアされます

### 4. 複数ノードの一括操作

#### 一括移動
- 複数選択した状態で、いずれかの選択ノードをドラッグすると全ての選択ノードが同時に移動します
- 相対位置を保持したまま移動します

#### 一括削除
- 複数選択した状態でDeleteキーを押すと、選択された全てのノードが削除されます
- **一括削除もUndo/Redo対応**

### 5. キャンバスのパン（移動）

- **操作方法**: マウスの右ボタンをクリックしてドラッグ
- **用途**: 大きなノードグラフを探索する際に便利
- **実装詳細**: TranslateTransformを使用した平行移動

### 6. キャンバスのズーム

- **操作方法**: マウスホイールを回転
  - 上方向スクロール: ズームイン（拡大）
  - 下方向スクロール: ズームアウト（縮小）
  
- **ズーム範囲**: 0.1倍 ～ 5.0倍
- **機能**: マウスカーソル位置を中心にズーム
- **実装詳細**: ScaleTransformを使用

### 7. ノードの削除

2つの方法でノードを削除できます：

1. **Deleteキーで削除**:
   - ノードを選択してDeleteキーを押す
   - 複数選択時は全ての選択ノードが削除されます
   - キャンバスにフォーカスがある状態で動作

2. **プロパティパネルから削除**:
   - ノードを単一選択
   - 右パネルの「ノードを削除」ボタンをクリック
   - 確認ダイアログが表示されます

- **動作**: ノード削除時、関連する接続も自動的に削除されます
- **Undo対応**: 削除したノードは接続情報ごと復元可能

### 8. Undo/Redo機能

全ての編集操作がUndo/Redo対応しています：

| 操作 | Undo内容 |
|------|----------|
| ノード追加 | ノードを削除 |
| ノード削除 | ノードと接続を復元 |
| ノード移動（単一） | 元の位置に戻す |
| ノード移動（複数） | 全ノードを元の位置に戻す |
| 接続追加 | 接続を削除 |
| 接続削除 | 接続を復元 |
| 接続置換 | 元の接続を復元 |
| プロパティ変更 | 元の値に戻す |

- **キーボードショートカット**: 
  - `Ctrl+Z`: Undo
  - `Ctrl+Shift+Z` または `Ctrl+Y`: Redo

### 9. プロパティパネル

選択したノードの詳細情報を右パネルに表示：

- **表示内容**:
  - ノード名（タイトル）
  - ノードタイプ（カテゴリ）
  - キャンバス上の位置（X, Y座標）
  - ノード固有のプロパティ（編集可能）
  - 入力ソケット一覧
  - 出力ソケット一覧
  - 削除ボタン

- **プロパティ編集**:
  - 数値はテキストボックスで直接編集
  - Enter/Tabで確定、Escapeでキャンセル
  - フォーカスを外すと自動確定

### 10. コンポーネントパレット

左パネルから新しいノードを追加：

#### オブジェクト
- **Sphere** - 球体
- **Plane** - 平面
- **Box** - 直方体

#### FBXオブジェクト
- Resource/Modelフォルダに配置したFBXファイルが自動的にリストされます
- 各FBXメッシュをノードとして追加可能

#### マテリアル
- **Universal PBR** - 物理ベースレンダリング用の統合マテリアル
- **BSDF** - Bidirectional Scattering Distribution Function
- **Emission** - 発光マテリアル

#### 数学
- **Float** - 浮動小数点数値
- **Vector3** - 3次元ベクトル (X, Y, Z)
- **Vector4** - 4次元ベクトル (X, Y, Z, W)
- **Color** - RGB色値
- **Transform** - 変換行列（位置、回転、スケール）
- **Combine Transform** - 複数のTransformを合成
- **Add** - 加算
- **Sub** - 減算
- **Mul** - 乗算
- **Div** - 除算

#### カメラ
- **Camera** - カメラノード（DoF対応）

#### ライト
- **Ambient Light** - 環境光
- **Directional Light** - 平行光源
- **Point Light** - 点光源

#### シーン
- **Scene** - シーン出力ノード（オブジェクトとライトを接続）

**使用方法**: カテゴリを展開してボタンをクリックするとビューポート中央にノードが追加されます

## キーボードショートカット

| キー | 機能 |
|------|------|
| Delete | 選択したノードを削除（複数可） |
| Ctrl+Z | Undo（元に戻す） |
| Ctrl+Y | Redo（やり直し） |
| Ctrl+Shift+Z | Redo（やり直し）※代替 |
| Enter | テキストボックスの入力確定 |
| Tab | 次のテキストボックスへ移動 |
| Shift+Tab | 前のテキストボックスへ移動 |
| Escape | テキストボックスの編集キャンセル |

## マウス操作まとめ

| 操作 | 機能 |
|------|------|
| 左クリック（ノード上） | ノードを単一選択 |
| 左クリック + ドラッグ（ノード上） | ノードを移動（複数選択時は全て移動） |
| 左クリック + ドラッグ（ソケット上） | 接続を作成 |
| 左クリック + ドラッグ（入力ソケット、接続あり） | 接続を付け替え/削除 |
| 左クリック + ドラッグ（空白） | 矩形選択 |
| 左クリック（空白） | 選択解除 |
| 右クリック + ドラッグ | キャンバスをパン |
| マウスホイール | ズーム |

## 技術実装の詳細

### アーキテクチャ

- **MVVM パターン**: ViewModelを通じたデータバインディング
- **ObservableCollection**: ノードと接続の自動UI更新
- **WPF トランスフォーム**: パン・ズーム機能の実装
- **ヒットテスト**: VisualTreeHelperを使った正確なクリック判定
- **Command パターン**: Undo/Redo機能の実装

### 主要クラス

1. **NodeEditorView**: ノードエディタのメインビュー
   - ドラッグ＆ドロップロジック
   - パン・ズーム処理
   - キーボード入力処理
   - 複数選択処理
   - 矩形選択処理

2. **Node**: ノードの基底クラス
   - 位置、タイトル、カテゴリ
   - 入力・出力ソケットの管理
   - 選択状態の管理
   - PBRプロパティ（Metallic/Roughness/Transmission/IOR/Emission）

3. **NodeSocket**: ソケット（入出力ポート）
   - ソケットタイプ（Object, Vector3, Float, Color, Material, Transform, Light等）
   - 親ノードへの参照
   - 値の保持

4. **NodeConnection**: ノード間の接続
   - 出力ソケットから入力ソケットへの接続
   - ベジェ曲線によるパスの計算
   - リアルタイム更新

5. **MainViewModel**: アプリケーションのメインViewModel
   - ノードコレクションの管理
   - 接続コレクションの管理
   - 選択状態の管理
   - レンダリング設定（SamplesPerPixel, MaxBounces, Exposure等）

6. **CommandManager**: Undo/Redo管理
   - IEditorCommandインターフェース
   - 履歴スタックの管理

### コマンドクラス（Undo/Redo用）

- **AddNodeCommand**: ノード追加
- **RemoveNodeCommand**: ノード削除（接続情報保持）
- **MoveNodeCommand**: 単一ノード移動
- **MoveNodesCommand**: 複数ノード移動
- **AddConnectionCommand**: 接続追加
- **RemoveConnectionCommand**: 接続削除
- **ReplaceConnectionCommand**: 接続置換
- **ChangePropertyCommand**: プロパティ変更
- **CompositeCommand**: 複数コマンドの一括実行

### カスタムコンバーター

- **BoolToSelectionBrushConverter**: 選択状態に応じた枠線の色変更
- **NullToVisibilityConverter**: nullの場合に表示
- **NotNullToVisibilityConverter**: nullでない場合に表示

## トラブルシューティング

### 接続が表示されない
- ノードを移動すると接続線が更新されます
- レンダリングウィンドウを閉じて再度開いてみてください

### ノードが選択できない
- キャンバスをクリックしてフォーカスを取得してください
- ズームレベルを調整してみてください

### キャンバスが動かない
- 右クリック（パン）と左クリック（選択/ドラッグ）を確認してください
- マウスホイールでズームできるか確認してください

### 複数選択が機能しない
- 空白部分からドラッグを開始してください
- ノードが矩形内に完全に収まるように選択してください

### Undo/Redoが効かない
- キーボードフォーカスがキャンバスにあることを確認してください
- Ctrl+Z / Ctrl+Y のショートカットを使用してください
