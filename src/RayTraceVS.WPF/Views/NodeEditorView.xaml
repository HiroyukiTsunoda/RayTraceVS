<UserControl x:Class="RayTraceVS.WPF.Views.NodeEditorView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:controls="clr-namespace:RayTraceVS.WPF.Views.Controls"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800"
             ClipToBounds="True"
             Focusable="True"
             PreviewKeyDown="UserControl_PreviewKeyDown"
             KeyDown="UserControl_KeyDown">
    <Grid>
        <!-- 統合キャンバス：イベント処理とトランスフォームを一元管理 -->
        <Canvas x:Name="NodeCanvas" 
                Panel.ZIndex="0"
                Width="12800"
                Height="7200"
                ClipToBounds="True"
                Focusable="True"
                MouseLeftButtonDown="Canvas_MouseLeftButtonDown"
                MouseLeftButtonUp="Canvas_MouseLeftButtonUp"
                MouseMove="Canvas_MouseMove"
                MouseRightButtonDown="Canvas_MouseRightButtonDown"
                MouseWheel="Canvas_MouseWheel"
                KeyDown="Canvas_KeyDown">
            
            <!-- グリッド背景 -->
            <Canvas.Background>
                <DrawingBrush Viewport="0,0,20,20" ViewportUnits="Absolute" 
                              TileMode="Tile">
                    <DrawingBrush.Drawing>
                        <GeometryDrawing>
                            <GeometryDrawing.Geometry>
                                <RectangleGeometry Rect="0,0,20,20"/>
                            </GeometryDrawing.Geometry>
                            <GeometryDrawing.Pen>
                                <Pen Brush="#2A2A2A" Thickness="0.5"/>
                            </GeometryDrawing.Pen>
                        </GeometryDrawing>
                    </DrawingBrush.Drawing>
                </DrawingBrush>
            </Canvas.Background>
            
            <!-- 接続線の中間部分用レイヤー（最下層） - 非選択ノードの接続線 -->
            <!-- DrawingVisualで一括描画することでパフォーマンス向上 -->
            <controls:ConnectionLineRenderer x:Name="MiddleConnectionRenderer"
                                             Connections="{Binding UnselectedNodeConnections}"
                                             RenderMode="Middle"
                                             Panel.ZIndex="0"/>
            
            <!-- ノード用キャンバス -->
            <Canvas x:Name="NodeLayer"
                    Panel.ZIndex="1">
                <ItemsControl ItemsSource="{Binding Nodes}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style>
                            <Setter Property="Canvas.Left" Value="{Binding Position.X}"/>
                            <Setter Property="Canvas.Top" Value="{Binding Position.Y}"/>
                            <Setter Property="Panel.ZIndex" Value="{Binding CreationIndex}"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <!-- ノードの表示 -->
                            <Border Background="{Binding CategoryColor}" 
                                    BorderBrush="{Binding IsSelected, Converter={StaticResource BoolToSelectionBrushConverter}}" 
                                    BorderThickness="2"
                                    CornerRadius="5"
                                    MinWidth="150"
                                    Padding="10"
                                    Cursor="Hand"
                                    MouseLeftButtonDown="Node_MouseLeftButtonDown"
                                    MouseLeftButtonUp="Node_MouseLeftButtonUp"
                                    MouseMove="Node_MouseMove">
                                <Border.MinHeight>
                                    <MultiBinding Converter="{StaticResource SocketCountToHeightConverter}">
                                        <Binding Path="InputSockets"/>
                                        <Binding Path="OutputSockets"/>
                                    </MultiBinding>
                                </Border.MinHeight>
                                <StackPanel>
                                    <TextBlock Text="{Binding Title}" 
                                               FontWeight="Bold"
                                               Foreground="{StaticResource TextBrush}"
                                               HorizontalAlignment="Center"
                                               Margin="0,0,0,5"/>
                                    
                                    <!-- 入力ソケット -->
                                    <ItemsControl ItemsSource="{Binding InputSockets}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal" Margin="0,2">
                                                    <Ellipse x:Name="InputSocketEllipse"
                                                             Width="12" Height="12" 
                                                             Fill="{Binding SocketColor}"
                                                             Stroke="{StaticResource AccentBrush}"
                                                             StrokeThickness="2"
                                                             Cursor="Cross"
                                                             DataContext="{Binding}"
                                                             Loaded="Socket_Loaded"
                                                             MouseEnter="Socket_MouseEnter"
                                                             MouseLeave="Socket_MouseLeave"/>
                                                    <TextBlock Text="{Binding Name}" 
                                                               Foreground="{StaticResource TextBrush}"
                                                               FontSize="10"
                                                               Margin="5,0,0,0"
                                                               VerticalAlignment="Center"/>
                                                    <!-- Vector3Node入力用テキストボックス -->
                                                    <TextBox Width="45"
                                                             Height="18"
                                                             FontSize="9"
                                                             Background="{Binding IsConnected, Converter={StaticResource ConnectedToBackgroundConverter}}"
                                                             Foreground="White"
                                                             BorderBrush="#555555"
                                                             BorderThickness="1"
                                                             VerticalContentAlignment="Center"
                                                             Padding="2,0"
                                                             Margin="3,0,0,0"
                                                             IsEnabled="{Binding IsConnected, Converter={StaticResource InverseBoolConverter}}"
                                                             Tag="{Binding}"
                                                             PreviewTextInput="Vector3TextBox_PreviewTextInput"
                                                             KeyDown="Vector3TextBox_KeyDown"
                                                             LostFocus="Vector3TextBox_LostFocus"
                                                             GotFocus="Vector3TextBox_GotFocus"
                                                             Loaded="Vector3TextBox_Loaded"
                                                             Visibility="{Binding ParentNode.HasEditableVector3Inputs, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                    <!-- Vector4Node入力用テキストボックス -->
                                                    <TextBox Width="45"
                                                             Height="18"
                                                             FontSize="9"
                                                             Background="{Binding IsConnected, Converter={StaticResource ConnectedToBackgroundConverter}}"
                                                             Foreground="White"
                                                             BorderBrush="#555555"
                                                             BorderThickness="1"
                                                             VerticalContentAlignment="Center"
                                                             Padding="2,0"
                                                             Margin="3,0,0,0"
                                                             IsEnabled="{Binding IsConnected, Converter={StaticResource InverseBoolConverter}}"
                                                             Tag="{Binding}"
                                                             PreviewTextInput="Vector4TextBox_PreviewTextInput"
                                                             KeyDown="Vector4TextBox_KeyDown"
                                                             LostFocus="Vector4TextBox_LostFocus"
                                                             GotFocus="Vector4TextBox_GotFocus"
                                                             Loaded="Vector4TextBox_Loaded"
                                                             Visibility="{Binding ParentNode.HasEditableVector4Inputs, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                    <!-- ColorNode入力用テキストボックス -->
                                                    <TextBox Width="45"
                                                             Height="18"
                                                             FontSize="9"
                                                             Background="{Binding IsConnected, Converter={StaticResource ConnectedToBackgroundConverter}}"
                                                             Foreground="White"
                                                             BorderBrush="#555555"
                                                             BorderThickness="1"
                                                             VerticalContentAlignment="Center"
                                                             Padding="2,0"
                                                             Margin="3,0,0,0"
                                                             IsEnabled="{Binding IsConnected, Converter={StaticResource InverseBoolConverter}}"
                                                             Tag="{Binding}"
                                                             PreviewTextInput="ColorTextBox_PreviewTextInput"
                                                             KeyDown="ColorTextBox_KeyDown"
                                                             LostFocus="ColorTextBox_LostFocus"
                                                             GotFocus="ColorTextBox_GotFocus"
                                                             Loaded="ColorTextBox_Loaded"
                                                             Visibility="{Binding ParentNode.HasEditableColorInputs, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                    
                                    <!-- FloatNode用の値入力テキストボックス -->
                                    <Grid Visibility="{Binding HasEditableFloat, Converter={StaticResource BoolToVisibilityConverter}}"
                                          Margin="0,2">
                                        <TextBox x:Name="FloatValueTextBox"
                                                 Text="{Binding EditableFloatValue, Mode=TwoWay, UpdateSourceTrigger=LostFocus, StringFormat={}{0:G}}"
                                                 Width="60"
                                                 Height="20"
                                                 FontSize="10"
                                                 Background="#3A3A3A"
                                                 Foreground="White"
                                                 BorderBrush="#555555"
                                                 BorderThickness="1"
                                                 HorizontalAlignment="Left"
                                                 VerticalContentAlignment="Center"
                                                 Padding="3,0"
                                                 PreviewTextInput="FloatTextBox_PreviewTextInput"
                                                 KeyDown="FloatTextBox_KeyDown"
                                                 LostFocus="FloatTextBox_LostFocus"
                                                 GotFocus="FloatTextBox_GotFocus"/>
                                    </Grid>

                                    <!-- 出力ソケット -->
                                    <ItemsControl ItemsSource="{Binding OutputSockets}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal" 
                                                           HorizontalAlignment="Right"
                                                           Margin="0,2">
                                                    <TextBlock Text="{Binding Name}" 
                                                               Foreground="{StaticResource TextBrush}"
                                                               FontSize="10"
                                                               Margin="0,0,5,0"
                                                               VerticalAlignment="Center"/>
                                                    <Ellipse x:Name="OutputSocketEllipse"
                                                             Width="12" Height="12" 
                                                             Fill="{Binding SocketColor}"
                                                             Stroke="{StaticResource AccentBrush}"
                                                             StrokeThickness="2"
                                                             Cursor="Cross"
                                                             DataContext="{Binding}"
                                                             Loaded="Socket_Loaded"
                                                             MouseEnter="Socket_MouseEnter"
                                                             MouseLeave="Socket_MouseLeave"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Canvas>
            
            <!-- 接続線の端部分用レイヤー（ノードより上） - 非選択ノードの接続線 -->
            <!-- DrawingVisualで一括描画することでパフォーマンス向上 -->
            <controls:ConnectionLineRenderer x:Name="EndSegmentRenderer"
                                             Connections="{Binding UnselectedNodeConnections}"
                                             RenderMode="StartEnd"
                                             Panel.ZIndex="2"/>
            
            <!-- 選択ノードの接続線用レイヤー（ノードより上） -->
            <!-- DrawingVisualで一括描画することでパフォーマンス向上 -->
            <controls:ConnectionLineRenderer x:Name="SelectedConnectionRenderer"
                                             Connections="{Binding SelectedNodeConnections}"
                                             RenderMode="Full"
                                             Panel.ZIndex="3"/>
            
            <!-- プレビュー線・選択矩形用レイヤー（最上層） -->
            <Canvas x:Name="PreviewLayer"
                    Panel.ZIndex="4"
                    IsHitTestVisible="False"/>
        </Canvas>
        
        <!-- ナビゲーション情報 -->
        <Border VerticalAlignment="Top" HorizontalAlignment="Right" 
                Margin="10" Background="#80000000" Padding="5">
            <StackPanel>
                <TextBlock Text="ノードエディタ" Foreground="White" FontWeight="Bold"/>
                <TextBlock x:Name="InfoText" Foreground="White" FontSize="10">
                    <Run Text="左クリック: ノード移動"/>
                    <LineBreak/>
                    <Run Text="左ドラッグ: 矩形選択"/>
                    <LineBreak/>
                    <Run Text="右クリック: パン"/>
                    <LineBreak/>
                    <Run Text="ホイール: ズーム"/>
                    <LineBreak/>
                    <Run Text="Delete: ノード削除"/>
                </TextBlock>
            </StackPanel>
        </Border>

        <!-- ソケット型表示用ポップアップ -->
        <Popup x:Name="SocketTypePopup"
               AllowsTransparency="True"
               StaysOpen="True"
               Placement="Mouse"
               PopupAnimation="None"
               IsHitTestVisible="False">
            <Border Background="#E0333333"
                    BorderBrush="#888888"
                    BorderThickness="1"
                    CornerRadius="3"
                    Padding="8,4"
                    IsHitTestVisible="False">
                <TextBlock x:Name="SocketTypeText"
                           Foreground="White"
                           FontSize="12"
                           IsHitTestVisible="False"/>
            </Border>
        </Popup>
    </Grid>
</UserControl>
