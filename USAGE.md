# RayTraceVS 使い方ガイド

## 初めての方へ

### 1. サンプルシーンを開く

アプリケーションを起動したら、まずサンプルシーンを開いてみましょう。

1. メニューから **「ファイル」→「開く」** を選択
2. `sample_scene.rtvs` ファイルを選択して開く
3. ノードエディタに以下のノードが表示されます：
   - 球ノード（赤い球体）
   - 平面ノード（床）
   - カメラノード（視点）
   - ライトノード（照明）
   - シーンノード（最終出力）

### 2. レンダリングを実行する

サンプルシーンが読み込まれたら、レイトレーシングを実行します。

1. メニューから **「レンダリング」→「レンダリング開始」** を選択
2. レンダリングウィンドウが開きます
3. ウィンドウ下部の **「開始」** ボタンをクリック
4. レイトレーシングの結果がリアルタイムで表示されます

### 3. レンダリングを停止する

- レンダリングウィンドウの **「停止」** ボタンをクリック
- または、メニューから **「レンダリング」→「レンダリング停止」** を選択
- レンダリングウィンドウを閉じる

## ノードエディタの使い方

### ノードを追加する

1. 左パネルの「コンポーネントパレット」から追加したいノードのボタンをクリック
2. ノードがノードエディタ（中央パネル）に自動的に配置されます

### 使用可能なノード

#### オブジェクトノード
- **球（Sphere）**: 球体オブジェクト
  - プロパティ: 位置、半径、色、PBRマテリアル（Metallic/Roughness/Transmission/IOR/Emission）
- **平面（Plane）**: 無限平面
  - プロパティ: 位置、法線、色、PBRマテリアル
- **ボックス（Box）**: 直方体オブジェクト
  - プロパティ: 位置、サイズ、色、PBRマテリアル

#### マテリアルノード
- **DiffuseMaterial**: 拡散反射マテリアル
- **MetalMaterial**: 金属マテリアル（反射、GGX-like roughness）
- **GlassMaterial**: ガラスマテリアル（屈折）
- **EmissionMaterial**: 発光マテリアル

#### カメラノード
- **カメラ**: 視点設定
  - プロパティ: 位置、注視点、上方向ベクトル、視野角、被写界深度（ApertureSize/FocusDistance）

#### ライトノード
- **ポイントライト**: 点光源（ソフトシャドウ対応）
  - プロパティ: 位置、色、強度、半径
- **ディレクショナルライト**: 方向性ライト（太陽光など）
  - プロパティ: 方向、色、強度
- **アンビエントライト**: 環境光
  - プロパティ: 色、強度

#### シーンノード
- **シーン出力**: 最終的なシーン構成
  - 入力ソケット: カメラ、オブジェクト、ライト
  - レンダリング設定: SamplesPerPixel、MaxBounces、Exposure、ToneMapOperator

#### 数学ノード
- **Vector3**: 3Dベクトル値（位置・方向）
- **Float**: 浮動小数点値
- **Color**: 色値

### ノードを接続する

ノード間を接続することで、データの流れを構築します。

#### 基本的な接続方法

1. 出力ソケット（ノードの右側の丸）をクリック
2. 入力ソケット（ノードの左側の丸）までドラッグ
3. マウスを離して接続を確定

**機能**: 
- ドラッグ中はプレビュー線（点線）が表示されます
- ソケット型の互換性チェック（互換性がない場合は赤色で表示）
- 既存の接続がある入力ソケットをドラッグすると、接続を別のソケットに付け替えられます

#### 接続ルール

- **オブジェクトノードの出力** → **シーンノードの「Objects」入力**
- **カメラノードの出力** → **シーンノードの「Camera」入力**
- **ライトノードの出力** → **シーンノードの「Lights」入力**
- **マテリアルノードの出力** → **オブジェクトノードの「Material」入力**
- **Vector3ノードの出力** → **オブジェクトノードの「Position」「Normal」等の入力**

### ノードを選択・移動する

#### 単一選択
- ノードをクリックして選択
- 選択したノードは青い枠線でハイライト

#### 複数選択（矩形選択）
- キャンバスの空白部分から左クリック＆ドラッグで矩形を描く
- 矩形内に完全に収まるノードが全て選択されます

#### ノードの移動
- 単一選択: ノードをドラッグ
- 複数選択: いずれかの選択ノードをドラッグすると全て同時に移動
- **移動はUndo/Redo対応**

### ノードを削除する

2つの方法でノードを削除できます：

1. **Deleteキーで削除**:
   - ノードを選択してDeleteキーを押す
   - 複数選択時は全ての選択ノードが削除されます
   
2. **プロパティパネルから削除**:
   - ノードを単一選択
   - 右パネルの「ノードを削除」ボタンをクリック

**注意**: ノード削除時、関連する接続も自動的に削除されます（Undo可能）

### ノードのプロパティを確認する

1. ノードをクリックして選択
2. 右パネルの「プロパティ」に以下の情報が表示されます：
   - ノード名
   - ノードタイプ
   - キャンバス上の位置
   - 入力ソケット一覧
   - 出力ソケット一覧

**注意**: プロパティ値の詳細編集機能は実装予定です。現在は情報の確認のみ可能です。

## シーンファイルの保存と読み込み

### 保存

1. メニューから **「ファイル」→「保存」** または **「名前を付けて保存」** を選択
2. ファイル名を入力して保存（拡張子: `.rtvs`）

### 読み込み

1. メニューから **「ファイル」→「開く」** を選択
2. 保存したシーンファイル（`.rtvs`）を選択

### 新規シーン

1. メニューから **「ファイル」→「新規シーン」** を選択
2. 確認ダイアログで「はい」を選択すると、現在のシーンがクリアされます

## レンダリング設定

レンダリングウィンドウで以下の設定が可能です：

### 解像度変更

ウィンドウ下部のドロップダウンから選択：
- 1280x720（デフォルト）
- 1920x1080
- 2560x1440
- 3840x2160

### レンダリング結果の保存

1. レンダリングウィンドウの **「保存」** ボタンをクリック
2. ファイル形式を選択（PNG、JPEG、BMP）
3. ファイル名を入力して保存

**注意**: 画像保存機能は現在実装中です。

## トラブルシューティング

### レンダリングが開始できない

**原因**: DirectX 12 DXRに対応していないGPUまたはドライバ

**解決策**:
1. グラフィックスドライバを最新版に更新
2. GPUがDirectX 12に対応しているか確認
3. Windows 10 2004以降であることを確認

### シーンが表示されない

**原因**: シーンノードにカメラとオブジェクトが接続されていない

**解決策**:
1. シーンノードが配置されているか確認
2. カメラノードの出力がシーンノードの「カメラ」入力に接続されているか確認
3. オブジェクトノードの出力がシーンノードの「オブジェクト1-3」に接続されているか確認

### ノードが見えない

**原因**: ノードがビューポートの外に配置されている

**解決策**:
1. マウス右ボタンでドラッグしてパン（移動）
2. マウスホイールでズームイン/ズームアウト
3. 「ファイル」→「開く」でサンプルシーンを再度読み込む

### 接続が作成できない

**原因**: 接続ルールに違反している

**解決策**:
1. 出力ソケット（右側）から入力ソケット（左側）の順でドラッグしているか確認
2. 同じノード内のソケット同士を接続していないか確認
3. ソケットの色が同じ（互換性のあるタイプ）か確認

## マウス＆キーボード操作

### マウス操作

| 操作 | 機能 |
|------|------|
| **左クリック + ドラッグ（ノード上）** | ノードを移動 |
| **左クリック + ドラッグ（ソケット上）** | 接続を作成 |
| **左クリック（空白）** | 選択解除 |
| **右クリック + ドラッグ** | キャンバスをパン（移動） |
| **マウスホイール** | ズーム（0.1倍 ～ 5.0倍） |

### キーボードショートカット

| キー | 機能 |
|------|------|
| Delete | 選択したノードを削除（複数可） |
| Ctrl+Z | Undo（元に戻す） |
| Ctrl+Y | Redo（やり直し） |
| Ctrl+Shift+Z | Redo（やり直し）※代替 |
| Enter | テキストボックスの入力確定 |
| Tab | 次のテキストボックスへ移動 |
| Escape | テキストボックスの編集キャンセル |

## レンダリングのヒント

### 美しいレンダリング結果を得るために

1. **ライトの配置**: 
   - ライトの位置を調整して、オブジェクトに陰影をつける
   - 強度を調整して明るさを変更
   - ポイントライトの半径を大きくするとソフトシャドウが得られる

2. **カメラの位置**:
   - カメラの位置と注視点を調整して、良い構図を探す
   - 視野角を変更して遠近感を調整
   - ApertureSizeを設定すると被写界深度（ボケ）効果が得られる

3. **マテリアル設定（PBR）**:
   - **Metallic**: 0=非金属、1=金属（反射が強くなる）
   - **Roughness**: 0=鏡面、1=拡散（0に近いほど鮮明な反射）
   - **Transmission**: ガラス用、0=不透明、1=完全透過
   - **IOR**: 屈折率（ガラス=1.5、水=1.33など）
   - **Emission**: 自己発光色（照明なしでも光る）

4. **オブジェクトの配置**:
   - 平面を床として使用
   - 複数の球やボックスを配置してシーンを豊かに
   - ガラス球でコースティクス効果を確認

5. **デノイザー設定**:
   - NRD（REBLUR + SIGMA）でノイズを除去
   - roughness < 0.05 の完全鏡面はデノイザーをバイパス

## 次のステップ

1. サンプルシーンのパラメータを変更して実験してみる
2. ノードを追加してより複雑なシーンを作成
3. 独自のシーンを作成して保存

## 参考情報

- **プロジェクトドキュメント**: [README.md](README.md)
- **ビルドガイド**: [BUILD_GUIDE.md](BUILD_GUIDE.md)
- **ノードエディタガイド**: [NODE_EDITOR_GUIDE.md](NODE_EDITOR_GUIDE.md)
- **レンダリング実装詳細**: [RENDERING_IMPLEMENTATION.md](RENDERING_IMPLEMENTATION.md)
- **実装サマリー**: [IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md)
